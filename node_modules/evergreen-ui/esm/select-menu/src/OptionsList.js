import _extends from "@babel/runtime/helpers/esm/extends";
import _objectWithoutProperties from "@babel/runtime/helpers/esm/objectWithoutProperties";
import _classCallCheck from "@babel/runtime/helpers/esm/classCallCheck";
import _createClass from "@babel/runtime/helpers/esm/createClass";
import _possibleConstructorReturn from "@babel/runtime/helpers/esm/possibleConstructorReturn";
import _getPrototypeOf from "@babel/runtime/helpers/esm/getPrototypeOf";
import _inherits from "@babel/runtime/helpers/esm/inherits";
import _assertThisInitialized from "@babel/runtime/helpers/esm/assertThisInitialized";
import _defineProperty from "@babel/runtime/helpers/esm/defineProperty";
import React, { PureComponent } from 'react';
import PropTypes from 'prop-types';
import fuzzaldrin from 'fuzzaldrin-plus';
import VirtualList from 'react-tiny-virtual-list';
import { Pane } from '../../layers';
import { TableHead, SearchTableHeaderCell } from '../../table';
import OptionShapePropType from './OptionShapePropType';
import Option from './Option';
/**
 * Fuzzaldrin-plus is the default filter, but you can use your own
 * as long as they follow the following signature:
 * @param options <Array[String]> - ['label', 'label2', ...]
 * @param input <String>
 */

var fuzzyFilter = function fuzzyFilter(options, input) {
  return fuzzaldrin.filter(options, input);
};
/**
 * This is the default item renderer of options
 * you can pass custom renderers as long as they work the same as the Option
 */


var itemRenderer = function itemRenderer(props) {
  return React.createElement(Option, props);
};

itemRenderer.displayName = "itemRenderer";

var OptionsList =
/*#__PURE__*/
function (_PureComponent) {
  _inherits(OptionsList, _PureComponent);

  function OptionsList(props, context) {
    var _this;

    _classCallCheck(this, OptionsList);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(OptionsList).call(this, props, context));

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "isSelected", function (item) {
      var selected = _this.state.selected;
      return Boolean(selected.find(function (selectedItem) {
        return selectedItem === item.value;
      }));
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "search", function (options) {
      var optionsFilter = _this.props.optionsFilter;
      var searchValue = _this.state.searchValue;
      return searchValue.trim() === '' ? options // Return if no search query
      : optionsFilter(options.map(function (item) {
        return item.labelInList || item.label;
      }), searchValue).map(function (name) {
        return options.find(function (item) {
          return item.labelInList === name || item.label === name;
        });
      });
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "getCurrentIndex", function () {
      var selected = _this.props.selected;

      var options = _this.getFilteredOptions();

      return options.findIndex(function (option) {
        return option.value === selected[selected.length - 1];
      });
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleKeyDown", function (e) {
      if (e.keyCode === 38) {
        _this.handleArrowUp();
      }

      if (e.keyCode === 40) {
        _this.handleArrowDown();
      }

      if (e.keyCode === 13) {
        _this.handleEnter();
      }
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleArrowUp", function () {
      var onSelect = _this.props.onSelect;

      var options = _this.getFilteredOptions();

      var nextIndex = _this.getCurrentIndex() - 1;

      if (nextIndex < 0) {
        nextIndex = options.length - 1;
      }

      onSelect(options[nextIndex]);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleArrowDown", function () {
      var onSelect = _this.props.onSelect;

      var options = _this.getFilteredOptions();

      var nextIndex = _this.getCurrentIndex() + 1;

      if (nextIndex === options.length) {
        nextIndex = 0;
      }

      onSelect(options[nextIndex]);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleEnter", function () {
      var isSelected = _this.getCurrentIndex() !== -1;

      if (isSelected) {
        _this.props.close();
      }
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleChange", function (searchValue) {
      _this.setState({
        searchValue: searchValue
      });

      _this.props.onFilterChange(searchValue);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleSelect", function (item) {
      _this.props.onSelect(item);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleDeselect", function (item) {
      _this.props.onDeselect(item);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "assignSearchRef", function (ref) {
      _this.searchRef = ref;
    });

    _this.state = {
      searchValue: props.defaultSearchValue,
      selected: props.selected
    };
    return _this;
  }

  _createClass(OptionsList, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      var _this2 = this;

      var hasFilter = this.props.hasFilter;
      if (!hasFilter) return;
      /**
       * Hacky solution for broken autoFocus
       * https://github.com/segmentio/evergreen/issues/90
       */

      requestAnimationFrame(function () {
        _this2.searchRef.querySelector('input').focus();
      });
      window.addEventListener('keydown', this.handleKeyDown);
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      window.removeEventListener('keydown', this.handleKeyDown);
    }
  }, {
    key: "componentDidUpdate",
    value: function componentDidUpdate(prevProps) {
      if (prevProps.selected !== this.props.selected) {
        // eslint-disable-next-line react/no-did-update-set-state
        this.setState({
          selected: this.props.selected
        });
      }
    }
  }, {
    key: "getFilteredOptions",
    value: function getFilteredOptions() {
      var options = this.props.options;
      return this.search(options);
    }
  }, {
    key: "render",
    value: function render() {
      var _this3 = this;

      var _this$props = this.props,
          originalOptions = _this$props.options,
          close = _this$props.close,
          width = _this$props.width,
          height = _this$props.height,
          onSelect = _this$props.onSelect,
          onDeselect = _this$props.onDeselect,
          selected = _this$props.selected,
          hasFilter = _this$props.hasFilter,
          optionSize = _this$props.optionSize,
          _renderItem = _this$props.renderItem,
          placeholder = _this$props.placeholder,
          optionsFilter = _this$props.optionsFilter,
          isMultiSelect = _this$props.isMultiSelect,
          defaultSearchValue = _this$props.defaultSearchValue,
          props = _objectWithoutProperties(_this$props, ["options", "close", "width", "height", "onSelect", "onDeselect", "selected", "hasFilter", "optionSize", "renderItem", "placeholder", "optionsFilter", "isMultiSelect", "defaultSearchValue"]);

      var options = this.search(originalOptions);
      var listHeight = height - (hasFilter ? 32 : 0);
      var currentIndex = this.getCurrentIndex();
      var scrollToIndex = currentIndex === -1 ? 0 : currentIndex;
      return React.createElement(Pane, _extends({
        height: height,
        width: width,
        display: "flex",
        flexDirection: "column"
      }, props), hasFilter && React.createElement(TableHead, null, React.createElement(SearchTableHeaderCell, {
        onChange: this.handleChange,
        innerRef: this.assignSearchRef,
        borderRight: null,
        height: 32
      })), React.createElement(Pane, {
        flex: 1
      }, React.createElement(VirtualList, _extends({
        height: listHeight,
        width: "100%",
        itemSize: optionSize,
        itemCount: options.length,
        overscanCount: 20,
        scrollToAlignment: "auto"
      }, scrollToIndex ? {
        scrollToIndex: scrollToIndex
      } : {}, {
        renderItem: function renderItem(_ref) {
          var index = _ref.index,
              style = _ref.style;
          var item = options[index];

          var isSelected = _this3.isSelected(item);

          return _renderItem({
            key: item.value,
            label: item.label,
            style: style,
            height: optionSize,
            onSelect: function onSelect() {
              return _this3.handleSelect(item);
            },
            onDeselect: function onDeselect() {
              return _this3.handleDeselect(item);
            },
            isSelectable: !isSelected || isMultiSelect,
            isSelected: isSelected,
            disabled: item.disabled
          });
        }
      }))));
    }
  }]);

  return OptionsList;
}(PureComponent);

OptionsList.displayName = "OptionsList";

_defineProperty(OptionsList, "propTypes", {
  options: PropTypes.arrayOf(OptionShapePropType),
  close: PropTypes.func,
  height: PropTypes.number,
  width: PropTypes.number,

  /**
   * When true, multi select is accounted for.
   */
  isMultiSelect: PropTypes.bool,

  /**
   * This holds the values of the options
   */
  selected: PropTypes.arrayOf(PropTypes.string),
  onSelect: PropTypes.func,
  onDeselect: PropTypes.func,
  onFilterChange: PropTypes.func,
  hasFilter: PropTypes.bool,
  optionSize: PropTypes.number,
  renderItem: PropTypes.func,
  placeholder: PropTypes.string,
  optionsFilter: PropTypes.func,
  defaultSearchValue: PropTypes.string
});

_defineProperty(OptionsList, "defaultProps", {
  options: [],

  /**
   * Including border bottom
   * For some reason passing height to TableRow doesn't work
   * TODO: fix hacky solution
   */
  optionSize: 33,
  onSelect: function onSelect() {},
  onDeselect: function onDeselect() {},
  onFilterChange: function onFilterChange() {},
  selected: [],
  renderItem: itemRenderer,
  optionsFilter: fuzzyFilter,
  placeholder: 'Filter...',
  defaultSearchValue: ''
});

export { OptionsList as default };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZWxlY3QtbWVudS9zcmMvT3B0aW9uc0xpc3QuanMiXSwibmFtZXMiOlsiUmVhY3QiLCJQdXJlQ29tcG9uZW50IiwiUHJvcFR5cGVzIiwiZnV6emFsZHJpbiIsIlZpcnR1YWxMaXN0IiwiUGFuZSIsIlRhYmxlSGVhZCIsIlNlYXJjaFRhYmxlSGVhZGVyQ2VsbCIsIk9wdGlvblNoYXBlUHJvcFR5cGUiLCJPcHRpb24iLCJmdXp6eUZpbHRlciIsIm9wdGlvbnMiLCJpbnB1dCIsImZpbHRlciIsIml0ZW1SZW5kZXJlciIsInByb3BzIiwiT3B0aW9uc0xpc3QiLCJjb250ZXh0IiwiaXRlbSIsInNlbGVjdGVkIiwic3RhdGUiLCJCb29sZWFuIiwiZmluZCIsInNlbGVjdGVkSXRlbSIsInZhbHVlIiwib3B0aW9uc0ZpbHRlciIsInNlYXJjaFZhbHVlIiwidHJpbSIsIm1hcCIsImxhYmVsSW5MaXN0IiwibGFiZWwiLCJuYW1lIiwiZ2V0RmlsdGVyZWRPcHRpb25zIiwiZmluZEluZGV4Iiwib3B0aW9uIiwibGVuZ3RoIiwiZSIsImtleUNvZGUiLCJoYW5kbGVBcnJvd1VwIiwiaGFuZGxlQXJyb3dEb3duIiwiaGFuZGxlRW50ZXIiLCJvblNlbGVjdCIsIm5leHRJbmRleCIsImdldEN1cnJlbnRJbmRleCIsImlzU2VsZWN0ZWQiLCJjbG9zZSIsInNldFN0YXRlIiwib25GaWx0ZXJDaGFuZ2UiLCJvbkRlc2VsZWN0IiwicmVmIiwic2VhcmNoUmVmIiwiZGVmYXVsdFNlYXJjaFZhbHVlIiwiaGFzRmlsdGVyIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwicXVlcnlTZWxlY3RvciIsImZvY3VzIiwid2luZG93IiwiYWRkRXZlbnRMaXN0ZW5lciIsImhhbmRsZUtleURvd24iLCJyZW1vdmVFdmVudExpc3RlbmVyIiwicHJldlByb3BzIiwic2VhcmNoIiwib3JpZ2luYWxPcHRpb25zIiwid2lkdGgiLCJoZWlnaHQiLCJvcHRpb25TaXplIiwicmVuZGVySXRlbSIsInBsYWNlaG9sZGVyIiwiaXNNdWx0aVNlbGVjdCIsImxpc3RIZWlnaHQiLCJjdXJyZW50SW5kZXgiLCJzY3JvbGxUb0luZGV4IiwiaGFuZGxlQ2hhbmdlIiwiYXNzaWduU2VhcmNoUmVmIiwiaW5kZXgiLCJzdHlsZSIsImtleSIsImhhbmRsZVNlbGVjdCIsImhhbmRsZURlc2VsZWN0IiwiaXNTZWxlY3RhYmxlIiwiZGlzYWJsZWQiLCJhcnJheU9mIiwiZnVuYyIsIm51bWJlciIsImJvb2wiLCJzdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE9BQU9BLEtBQVAsSUFBZ0JDLGFBQWhCLFFBQXFDLE9BQXJDO0FBQ0EsT0FBT0MsU0FBUCxNQUFzQixZQUF0QjtBQUNBLE9BQU9DLFVBQVAsTUFBdUIsaUJBQXZCO0FBQ0EsT0FBT0MsV0FBUCxNQUF3Qix5QkFBeEI7QUFDQSxTQUFTQyxJQUFULFFBQXFCLGNBQXJCO0FBQ0EsU0FBU0MsU0FBVCxFQUFvQkMscUJBQXBCLFFBQWlELGFBQWpEO0FBQ0EsT0FBT0MsbUJBQVAsTUFBZ0MsdUJBQWhDO0FBQ0EsT0FBT0MsTUFBUCxNQUFtQixVQUFuQjtBQUVBOzs7Ozs7O0FBTUEsSUFBTUMsV0FBVyxHQUFHLFNBQWRBLFdBQWMsQ0FBQ0MsT0FBRCxFQUFVQyxLQUFWO0FBQUEsU0FBb0JULFVBQVUsQ0FBQ1UsTUFBWCxDQUFrQkYsT0FBbEIsRUFBMkJDLEtBQTNCLENBQXBCO0FBQUEsQ0FBcEI7QUFFQTs7Ozs7O0FBSUEsSUFBTUUsWUFBWSxHQUFHLFNBQWZBLFlBQWUsQ0FBQUMsS0FBSztBQUFBLFNBQUksb0JBQUMsTUFBRCxFQUFZQSxLQUFaLENBQUo7QUFBQSxDQUExQjs7QUFBTUQsWTs7SUFFZUUsVzs7Ozs7QUE2Q25CLHVCQUFZRCxLQUFaLEVBQW1CRSxPQUFuQixFQUE0QjtBQUFBOztBQUFBOztBQUMxQixxRkFBTUYsS0FBTixFQUFhRSxPQUFiOztBQUQwQix5RkFvQ2YsVUFBQUMsSUFBSSxFQUFJO0FBQUEsVUFDWEMsUUFEVyxHQUNF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Q2dGLElBaEJMO0FBaUJqQm5DLEVBQUFBLGNBQWMsRUFBRTdDLFNBQVMsQ0FBQ2dGLElBakJUO0FBa0JqQjlCLEVBQUFBLFNBQVMsRUFBRWxELFNBQVMsQ0FBQ2tGLElBbEJKO0FBbUJqQm5CLEVBQUFBLFVBQVUsRUFBRS9ELFNBQVMsQ0FBQ2lGLE1BbkJMO0FBb0JqQmpCLEVBQUFBLFVBQVUsRUFBRWhFLFNBQVMsQ0FBQ2dGLElBcEJMO0FBcUJqQmYsRUFBQUEsV0FBVyxFQUFFakUsU0FBUyxDQUFDbUYsTUFyQk47QUFzQmpCNUQsRUFBQUEsYUFBYSxFQUFFdkIsU0FBUyxDQUFDZ0YsSUF0QlI7QUF1QmpCL0IsRUFBQUEsa0JBQWtCLEVBQUVqRCxTQUFTLENBQUNtRjtBQXZCYixDOztnQkFEQXJFLFcsa0JBMkJHO0FBQ3BCTCxFQUFBQSxPQUFPLEVBQUUsRUFEVzs7QUFFcEI7Ozs7O0FBS0FzRCxFQUFBQSxVQUFVLEVBQUUsRUFQUTtBQVFwQnhCLEVBQUFBLFFBQVEsRUFBRSxvQkFBTSxDQUFFLENBUkU7QUFTcEJPLEVBQUFBLFVBQVUsRUFBRSxzQkFBTSxDQUFFLENBVEE7QUFVcEJELEVBQUFBLGNBQWMsRUFBRSwwQkFBTSxDQUFFLENBVko7QUFXcEI1QixFQUFBQSxRQUFRLEVBQUUsRUFYVTtBQVlwQitDLEVBQUFBLFVBQVUsRUFBRXBELFlBWlE7QUFhcEJXLEVBQUFBLGFBQWEsRUFBRWYsV0FiSztBQWNwQnlELEVBQUFBLFdBQVcsRUFBRSxXQWRPO0FBZXBCaEIsRUFBQUEsa0JBQWtCLEVBQUU7QUFmQSxDOztTQTNCSG5DLFciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgUHVyZUNvbXBvbmVudCB9IGZyb20gJ3JlYWN0J1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJ1xuaW1wb3J0IGZ1enphbGRyaW4gZnJvbSAnZnV6emFsZHJpbi1wbHVzJ1xuaW1wb3J0IFZpcnR1YWxMaXN0IGZyb20gJ3JlYWN0LXRpbnktdmlydHVhbC1saXN0J1xuaW1wb3J0IHsgUGFuZSB9IGZyb20gJy4uLy4uL2xheWVycydcbmltcG9ydCB7IFRhYmxlSGVhZCwgU2VhcmNoVGFibGVIZWFkZXJDZWxsIH0gZnJvbSAnLi4vLi4vdGFibGUnXG5pbXBvcnQgT3B0aW9uU2hhcGVQcm9wVHlwZSBmcm9tICcuL09wdGlvblNoYXBlUHJvcFR5cGUnXG5pbXBvcnQgT3B0aW9uIGZyb20gJy4vT3B0aW9uJ1xuXG4vKipcbiAqIEZ1enphbGRyaW4tcGx1cyBpcyB0aGUgZGVmYXVsdCBmaWx0ZXIsIGJ1dCB5b3UgY2FuIHVzZSB5b3VyIG93blxuICogYXMgbG9uZyBhcyB0aGV5IGZvbGxvdyB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZTpcbiAqIEBwYXJhbSBvcHRpb25zIDxBcnJheVtTdHJpbmddPiAtIFsnbGFiZWwnLCAnbGFiZWwyJywgLi4uXVxuICogQHBhcmFtIGlucHV0IDxTdHJpbmc+XG4gKi9cbmNvbnN0IGZ1enp5RmlsdGVyID0gKG9wdGlvbnMsIGlucHV0KSA9PiBmdXp6YWxkcmluLmZpbHRlcihvcHRpb25zLCBpbnB1dClcblxuLyoqXG4gKiBUaGlzIGlzIHRoZSBkZWZhdWx0IGl0ZW0gcmVuZGVyZXIgb2Ygb3B0aW9uc1xuICogeW91IGNhbiBwYXNzIGN1c3RvbSByZW5kZXJlcnMgYXMgbG9uZyBhcyB0aGV5IHdvcmsgdGhlIHNhbWUgYXMgdGhlIE9wdGlvblxuICovXG5jb25zdCBpdGVtUmVuZGVyZXIgPSBwcm9wcyA9PiA8T3B0aW9uIHsuLi5wcm9wc30gLz5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT3B0aW9uc0xpc3QgZXh0ZW5kcyBQdXJlQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICBvcHRpb25zOiBQcm9wVHlwZXMuYXJyYXlPZihPcHRpb25TaGFwZVByb3BUeXBlKSxcbiAgICBjbG9zZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgaGVpZ2h0OiBQcm9wVHlwZXMubnVtYmVyLFxuICAgIHdpZHRoOiBQcm9wVHlwZXMubnVtYmVyLFxuXG4gICAgLyoqXG4gICAgICogV2hlbiB0cnVlLCBtdWx0aSBzZWxlY3QgaXMgYWNjb3VudGVkIGZvci5cbiAgICAgKi9cbiAgICBpc011bHRpU2VsZWN0OiBQcm9wVHlwZXMuYm9vbCxcblxuICAgIC8qKlxuICAgICAqIFRoaXMgaG9sZHMgdGhlIHZhbHVlcyBvZiB0aGUgb3B0aW9uc1xuICAgICAqL1xuICAgIHNlbGVjdGVkOiBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMuc3RyaW5nKSxcbiAgICBvblNlbGVjdDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25EZXNlbGVjdDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25GaWx0ZXJDaGFuZ2U6IFByb3BUeXBlcy5mdW5jLFxuICAgIGhhc0ZpbHRlcjogUHJvcFR5cGVzLmJvb2wsXG4gICAgb3B0aW9uU2l6ZTogUHJvcFR5cGVzLm51bWJlcixcbiAgICByZW5kZXJJdGVtOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBwbGFjZWhvbGRlcjogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBvcHRpb25zRmlsdGVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBkZWZhdWx0U2VhcmNoVmFsdWU6IFByb3BUeXBlcy5zdHJpbmdcbiAgfVxuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgb3B0aW9uczogW10sXG4gICAgLyoqXG4gICAgICogSW5jbHVkaW5nIGJvcmRlciBib3R0b21cbiAgICAgKiBGb3Igc29tZSByZWFzb24gcGFzc2luZyBoZWlnaHQgdG8gVGFibGVSb3cgZG9lc24ndCB3b3JrXG4gICAgICogVE9ETzogZml4IGhhY2t5IHNvbHV0aW9uXG4gICAgICovXG4gICAgb3B0aW9uU2l6ZTogMzMsXG4gICAgb25TZWxlY3Q6ICgpID0+IHt9LFxuICAgIG9uRGVzZWxlY3Q6ICgpID0+IHt9LFxuICAgIG9uRmlsdGVyQ2hhbmdlOiAoKSA9PiB7fSxcbiAgICBzZWxlY3RlZDogW10sXG4gICAgcmVuZGVySXRlbTogaXRlbVJlbmRlcmVyLFxuICAgIG9wdGlvbnNGaWx0ZXI6IGZ1enp5RmlsdGVyLFxuICAgIHBsYWNlaG9sZGVyOiAnRmlsdGVyLi4uJyxcbiAgICBkZWZhdWx0U2VhcmNoVmFsdWU6ICcnXG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm9wcywgY29udGV4dCkge1xuICAgIHN1cGVyKHByb3BzLCBjb250ZXh0KVxuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIHNlYXJjaFZhbHVlOiBwcm9wcy5kZWZhdWx0U2VhcmNoVmFsdWUsXG4gICAgICBzZWxlY3RlZDogcHJvcHMuc2VsZWN0ZWRcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICBjb25zdCB7IGhhc0ZpbHRlciB9ID0gdGhpcy5wcm9wc1xuICAgIGlmICghaGFzRmlsdGVyKSByZXR1cm5cbiAgICAvKipcbiAgICAgKiBIYWNreSBzb2x1dGlvbiBmb3IgYnJva2VuIGF1dG9Gb2N1c1xuICAgICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9zZWdtZW50aW8vZXZlcmdyZWVuL2lzc3Vlcy85MFxuICAgICAqL1xuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICB0aGlzLnNlYXJjaFJlZi5xdWVyeVNlbGVjdG9yKCdpbnB1dCcpLmZvY3VzKClcbiAgICB9KVxuXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLmhhbmRsZUtleURvd24pXG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMuaGFuZGxlS2V5RG93bilcbiAgfVxuXG4gIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMpIHtcbiAgICBpZiAocHJldlByb3BzLnNlbGVjdGVkICE9PSB0aGlzLnByb3BzLnNlbGVjdGVkKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3Qvbm8tZGlkLXVwZGF0ZS1zZXQtc3RhdGVcbiAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICBzZWxlY3RlZDogdGhpcy5wcm9wcy5zZWxlY3RlZFxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBpc1NlbGVjdGVkID0gaXRlbSA9PiB7XG4gICAgY29uc3QgeyBzZWxlY3RlZCB9ID0gdGhpcy5zdGF0ZVxuXG4gICAgcmV0dXJuIEJvb2xlYW4oc2VsZWN0ZWQuZmluZChzZWxlY3RlZEl0ZW0gPT4gc2VsZWN0ZWRJdGVtID09PSBpdGVtLnZhbHVlKSlcbiAgfVxuXG4gIHNlYXJjaCA9IG9wdGlvbnMgPT4ge1xuICAgIGNvbnN0IHsgb3B0aW9uc0ZpbHRlciB9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IHsgc2VhcmNoVmFsdWUgfSA9IHRoaXMuc3RhdGVcblxuICAgIHJldHVybiBzZWFyY2hWYWx1ZS50cmltKCkgPT09ICcnXG4gICAgICA/IG9wdGlvbnMgLy8gUmV0dXJuIGlmIG5vIHNlYXJjaCBxdWVyeVxuICAgICAgOiBvcHRpb25zRmlsdGVyKFxuICAgICAgICAgIG9wdGlvbnMubWFwKGl0ZW0gPT4gaXRlbS5sYWJlbEluTGlzdCB8fCBpdGVtLmxhYmVsKSxcbiAgICAgICAgICBzZWFyY2hWYWx1ZVxuICAgICAgICApLm1hcChuYW1lID0+XG4gICAgICAgICAgb3B0aW9ucy5maW5kKGl0ZW0gPT4gaXRlbS5sYWJlbEluTGlzdCA9PT0gbmFtZSB8fCBpdGVtLmxhYmVsID09PSBuYW1lKVxuICAgICAgICApXG4gIH1cblxuICBnZXRDdXJyZW50SW5kZXggPSAoKSA9PiB7XG4gICAgY29uc3QgeyBzZWxlY3RlZCB9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdldEZpbHRlcmVkT3B0aW9ucygpXG5cbiAgICByZXR1cm4gb3B0aW9ucy5maW5kSW5kZXgoXG4gICAgICBvcHRpb24gPT4gb3B0aW9uLnZhbHVlID09PSBzZWxlY3RlZFtzZWxlY3RlZC5sZW5ndGggLSAxXVxuICAgIClcbiAgfVxuXG4gIGdldEZpbHRlcmVkT3B0aW9ucygpIHtcbiAgICBjb25zdCB7IG9wdGlvbnMgfSA9IHRoaXMucHJvcHNcblxuICAgIHJldHVybiB0aGlzLnNlYXJjaChvcHRpb25zKVxuICB9XG5cbiAgaGFuZGxlS2V5RG93biA9IGUgPT4ge1xuICAgIGlmIChlLmtleUNvZGUgPT09IDM4KSB7XG4gICAgICB0aGlzLmhhbmRsZUFycm93VXAoKVxuICAgIH1cblxuICAgIGlmIChlLmtleUNvZGUgPT09IDQwKSB7XG4gICAgICB0aGlzLmhhbmRsZUFycm93RG93bigpXG4gICAgfVxuXG4gICAgaWYgKGUua2V5Q29kZSA9PT0gMTMpIHtcbiAgICAgIHRoaXMuaGFuZGxlRW50ZXIoKVxuICAgIH1cbiAgfVxuXG4gIGhhbmRsZUFycm93VXAgPSAoKSA9PiB7XG4gICAgY29uc3QgeyBvblNlbGVjdCB9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdldEZpbHRlcmVkT3B0aW9ucygpXG5cbiAgICBsZXQgbmV4dEluZGV4ID0gdGhpcy5nZXRDdXJyZW50SW5kZXgoKSAtIDFcblxuICAgIGlmIChuZXh0SW5kZXggPCAwKSB7XG4gICAgICBuZXh0SW5kZXggPSBvcHRpb25zLmxlbmd0aCAtIDFcbiAgICB9XG5cbiAgICBvblNlbGVjdChvcHRpb25zW25leHRJbmRleF0pXG4gIH1cblxuICBoYW5kbGVBcnJvd0Rvd24gPSAoKSA9PiB7XG4gICAgY29uc3QgeyBvblNlbGVjdCB9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdldEZpbHRlcmVkT3B0aW9ucygpXG5cbiAgICBsZXQgbmV4dEluZGV4ID0gdGhpcy5nZXRDdXJyZW50SW5kZXgoKSArIDFcblxuICAgIGlmIChuZXh0SW5kZXggPT09IG9wdGlvbnMubGVuZ3RoKSB7XG4gICAgICBuZXh0SW5kZXggPSAwXG4gICAgfVxuXG4gICAgb25TZWxlY3Qob3B0aW9uc1tuZXh0SW5kZXhdKVxuICB9XG5cbiAgaGFuZGxlRW50ZXIgPSAoKSA9PiB7XG4gICAgY29uc3QgaXNTZWxlY3RlZCA9IHRoaXMuZ2V0Q3VycmVudEluZGV4KCkgIT09IC0xXG5cbiAgICBpZiAoaXNTZWxlY3RlZCkge1xuICAgICAgdGhpcy5wcm9wcy5jbG9zZSgpXG4gICAgfVxuICB9XG5cbiAgaGFuZGxlQ2hhbmdlID0gc2VhcmNoVmFsdWUgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgc2VhcmNoVmFsdWVcbiAgICB9KVxuICAgIHRoaXMucHJvcHMub25GaWx0ZXJDaGFuZ2Uoc2VhcmNoVmFsdWUpXG4gIH1cblxuICBoYW5kbGVTZWxlY3QgPSBpdGVtID0+IHtcbiAgICB0aGlzLnByb3BzLm9uU2VsZWN0KGl0ZW0pXG4gIH1cblxuICBoYW5kbGVEZXNlbGVjdCA9IGl0ZW0gPT4ge1xuICAgIHRoaXMucHJvcHMub25EZXNlbGVjdChpdGVtKVxuICB9XG5cbiAgYXNzaWduU2VhcmNoUmVmID0gcmVmID0+IHtcbiAgICB0aGlzLnNlYXJjaFJlZiA9IHJlZlxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIG9wdGlvbnM6IG9yaWdpbmFsT3B0aW9ucyxcbiAgICAgIGNsb3NlLFxuICAgICAgd2lkdGgsXG4gICAgICBoZWlnaHQsXG4gICAgICBvblNlbGVjdCxcbiAgICAgIG9uRGVzZWxlY3QsXG4gICAgICBzZWxlY3RlZCxcbiAgICAgIGhhc0ZpbHRlcixcbiAgICAgIG9wdGlvblNpemUsXG4gICAgICByZW5kZXJJdGVtLFxuICAgICAgcGxhY2Vob2xkZXIsXG4gICAgICBvcHRpb25zRmlsdGVyLFxuICAgICAgaXNNdWx0aVNlbGVjdCxcbiAgICAgIGRlZmF1bHRTZWFyY2hWYWx1ZSxcbiAgICAgIC4uLnByb3BzXG4gICAgfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5zZWFyY2gob3JpZ2luYWxPcHRpb25zKVxuICAgIGNvbnN0IGxpc3RIZWlnaHQgPSBoZWlnaHQgLSAoaGFzRmlsdGVyID8gMzIgOiAwKVxuICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IHRoaXMuZ2V0Q3VycmVudEluZGV4KClcbiAgICBjb25zdCBzY3JvbGxUb0luZGV4ID0gY3VycmVudEluZGV4ID09PSAtMSA/IDAgOiBjdXJyZW50SW5kZXhcblxuICAgIHJldHVybiAoXG4gICAgICA8UGFuZVxuICAgICAgICBoZWlnaHQ9e2hlaWdodH1cbiAgICAgICAgd2lkdGg9e3dpZHRofVxuICAgICAgICBkaXNwbGF5PVwiZmxleFwiXG4gICAgICAgIGZsZXhEaXJlY3Rpb249XCJjb2x1bW5cIlxuICAgICAgICB7Li4ucHJvcHN9XG4gICAgICA+XG4gICAgICAgIHtoYXNGaWx0ZXIgJiYgKFxuICAgICAgICAgIDxUYWJsZUhlYWQ+XG4gICAgICAgICAgICA8U2VhcmNoVGFibGVIZWFkZXJDZWxsXG4gICAgICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLmhhbmRsZUNoYW5nZX1cbiAgICAgICAgICAgICAgaW5uZXJSZWY9e3RoaXMuYXNzaWduU2VhcmNoUmVmfVxuICAgICAgICAgICAgICBib3JkZXJSaWdodD17bnVsbH1cbiAgICAgICAgICAgICAgaGVpZ2h0PXszMn1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgPC9UYWJsZUhlYWQ+XG4gICAgICAgICl9XG4gICAgICAgIDxQYW5lIGZsZXg9ezF9PlxuICAgICAgICAgIDxWaXJ0dWFsTGlzdFxuICAgICAgICAgICAgaGVpZ2h0PXtsaXN0SGVpZ2h0fVxuICAgICAgICAgICAgd2lkdGg9XCIxMDAlXCJcbiAgICAgICAgICAgIGl0ZW1TaXplPXtvcHRpb25TaXplfVxuICAgICAgICAgICAgaXRlbUNvdW50PXtvcHRpb25zLmxlbmd0aH1cbiAgICAgICAgICAgIG92ZXJzY2FuQ291bnQ9ezIwfVxuICAgICAgICAgICAgc2Nyb2xsVG9BbGlnbm1lbnQ9XCJhdXRvXCJcbiAgICAgICAgICAgIHsuLi4oc2Nyb2xsVG9JbmRleFxuICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIHNjcm9sbFRvSW5kZXhcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDoge30pfVxuICAgICAgICAgICAgcmVuZGVySXRlbT17KHsgaW5kZXgsIHN0eWxlIH0pID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IG9wdGlvbnNbaW5kZXhdXG4gICAgICAgICAgICAgIGNvbnN0IGlzU2VsZWN0ZWQgPSB0aGlzLmlzU2VsZWN0ZWQoaXRlbSlcbiAgICAgICAgICAgICAgcmV0dXJuIHJlbmRlckl0ZW0oe1xuICAgICAgICAgICAgICAgIGtleTogaXRlbS52YWx1ZSxcbiAgICAgICAgICAgICAgICBsYWJlbDogaXRlbS5sYWJlbCxcbiAgICAgICAgICAgICAgICBzdHlsZSxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IG9wdGlvblNpemUsXG4gICAgICAgICAgICAgICAgb25TZWxlY3Q6ICgpID0+IHRoaXMuaGFuZGxlU2VsZWN0KGl0ZW0pLFxuICAgICAgICAgICAgICAgIG9uRGVzZWxlY3Q6ICgpID0+IHRoaXMuaGFuZGxlRGVzZWxlY3QoaXRlbSksXG4gICAgICAgICAgICAgICAgaXNTZWxlY3RhYmxlOiAhaXNTZWxlY3RlZCB8fCBpc011bHRpU2VsZWN0LFxuICAgICAgICAgICAgICAgIGlzU2VsZWN0ZWQsXG4gICAgICAgICAgICAgICAgZGlzYWJsZWQ6IGl0ZW0uZGlzYWJsZWRcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH19XG4gICAgICAgICAgLz5cbiAgICAgICAgPC9QYW5lPlxuICAgICAgPC9QYW5lPlxuICAgIClcbiAgfVxufVxuIl19
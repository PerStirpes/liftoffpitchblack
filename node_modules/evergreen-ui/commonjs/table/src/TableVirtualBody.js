"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _reactTinyVirtualList = _interopRequireDefault(require("react-tiny-virtual-list"));

var _lodash = _interopRequireDefault(require("lodash.debounce"));

var _layers = require("../../layers");

var TableVirtualBody =
/*#__PURE__*/
function (_PureComponent) {
  (0, _inherits2.default)(TableVirtualBody, _PureComponent);
  (0, _createClass2.default)(TableVirtualBody, null, [{
    key: "getDerivedStateFromProps",
    value: function getDerivedStateFromProps(props, state) {
      if (props.height !== state.calculatedHeight) {
        return {
          isIntegerHeight: Number.isInteger(props.height)
        };
      } // Return null to indicate no change to state.


      return null;
    }
  }]);

  function TableVirtualBody(props) {
    var _this;

    (0, _classCallCheck2.default)(this, TableVirtualBody);
    _this = (0, _possibleConstructorReturn2.default)(this, (0, _getPrototypeOf2.default)(TableVirtualBody).call(this, props));
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "state", {
      isIntegerHeight: false,
      calculatedHeight: 0
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "initializeHelpers", function () {
      _this.autoHeights = [];
      _this.autoHeightRefs = [];
      _this.averageAutoHeight = _this.props.defaultHeight;
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "processAutoHeights", function () {
      var isUpdated = false; // This will determine the averageAutoHeight.

      var total = 0;
      var totalAmount = 0; // Loop through all of the refs that have height="auto".

      _this.autoHeightRefs.forEach(function (ref, index) {
        // If the height is already calculated, skip it,
        // but calculate the height for the total.
        if (_this.autoHeights[index]) {
          total += _this.autoHeights[index];
          totalAmount += 1;
          return;
        } // Make sure the ref has a child


        if (ref && ref.childNodes && ref.childNodes[0] && Number.isInteger(ref.childNodes[0].offsetHeight)) {
          var height = ref.childNodes[0].offsetHeight; // Add to the total to calculate the averageAutoHeight.

          total += height;
          totalAmount += 1; // Cache the height.

          _this.autoHeights[index] = height; // Set the update flag to true.

          isUpdated = true;
        }
      }); // Save the average height.


      _this.averageAutoHeight = total / totalAmount; // There are some new heights detected that had previously not been calculated.
      // Call forceUpdate to make sure the virtual list renders again.

      if (isUpdated) _this.forceUpdate();
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "onRef", function (ref) {
      _this.paneRef = ref;
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "onVirtualHelperRef", function (index, ref) {
      _this.autoHeightRefs[index] = ref;
      requestAnimationFrame(function () {
        _this.processAutoHeights();
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "onResize", function () {
      _this.updateOnResize();
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "updateOnResize", function () {
      _this.initializeHelpers(); // Simply return when we now the height of the pane is fixed.


      if (_this.state.isIntegerHeight) return; // Return if we are in a weird edge case in which the ref is no longer valid.

      if (_this.paneRef) {
        var calculatedHeight = _this.paneRef.offsetHeight;

        if (calculatedHeight > 0) {
          // Save the calculated height which is needed for the VirtualList.
          _this.setState({
            calculatedHeight: calculatedHeight
          }); // Prevent updateOnResize being called recursively when there is a valid height.


          return;
        }
      } // When height is still 0 (or paneRef is not valid) try recursively until success.


      requestAnimationFrame(function () {
        _this.updateOnResize();
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "getItemSize", function (children) {
      var _this$props = _this.props,
          allowAutoHeight = _this$props.allowAutoHeight,
          useAverageAutoHeightEstimation = _this$props.useAverageAutoHeightEstimation,
          defaultHeight = _this$props.defaultHeight; // Prefer to return a array of all heights.

      if (!allowAutoHeight) {
        return children.map(function (child) {
          if (!_react.default.isValidElement(child)) return defaultHeight;
          var height = child.props.height;

          if (Number.isInteger(height)) {
            return height;
          }

          return defaultHeight;
        });
      } // If allowAutoHeight is true, return a function instead.


      var itemSizeFn = function itemSizeFn(index) {
        if (!_react.default.isValidElement(children[index])) return defaultHeight;
        var height = children[index].props.height; // When the height is number simply, simply return it.

        if (Number.isInteger(height)) {
          return height;
        } // When allowAutoHeight is set and  the height is set to "auto"...


        if (allowAutoHeight && children[index].props.height === 'auto') {
          // ... and the height is calculated, return the calculated height.
          if (_this.autoHeights[index]) return _this.autoHeights[index]; // ... if the height is not yet calculated, return the averge

          if (useAverageAutoHeightEstimation) return _this.averageAutoHeight;
        } // Return the default height.


        return defaultHeight;
      };

      return itemSizeFn;
    });

    _this.initializeHelpers(); // Add a onResize.


    _this.onResize = (0, _lodash.default)(_this.onResize, 200);
    return _this;
  }

  (0, _createClass2.default)(TableVirtualBody, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      // Call this to initialize and set
      this.updateOnResize();
      window.addEventListener('resize', this.onResize, false);
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      window.removeEventListener('resize', this.onResize);
    }
  }, {
    key: "render",
    value: function render() {
      var _this2 = this;

      var _this$props2 = this.props,
          inputChildren = _this$props2.children,
          paneHeight = _this$props2.height,
          defaultHeight = _this$props2.defaultHeight,
          allowAutoHeight = _this$props2.allowAutoHeight,
          overscanCount = _this$props2.overscanCount,
          estimatedItemSize = _this$props2.estimatedItemSize,
          useAverageAutoHeightEstimation = _this$props2.useAverageAutoHeightEstimation,
          scrollToIndex = _this$props2.scrollToIndex,
          scrollOffset = _this$props2.scrollOffset,
          scrollToAlignment = _this$props2.scrollToAlignment,
          props = (0, _objectWithoutProperties2.default)(_this$props2, ["children", "height", "defaultHeight", "allowAutoHeight", "overscanCount", "estimatedItemSize", "useAverageAutoHeightEstimation", "scrollToIndex", "scrollOffset", "scrollToAlignment"]); // Children always needs to be an array.

      var children = Array.isArray(inputChildren) ? inputChildren : _react.default.Children.toArray(inputChildren);
      var itemSize = this.getItemSize(children); // VirtualList needs a fixed height.

      var _this$state = this.state,
          calculatedHeight = _this$state.calculatedHeight,
          isIntegerHeight = _this$state.isIntegerHeight;
      return _react.default.createElement(_layers.Pane, (0, _extends2.default)({
        "data-evergreen-table-body": true,
        innerRef: this.onRef,
        height: paneHeight,
        flex: "1",
        overflow: "hidden"
      }, props), _react.default.createElement(_reactTinyVirtualList.default, {
        height: isIntegerHeight ? paneHeight : calculatedHeight,
        width: "100%",
        estimatedItemSize: allowAutoHeight && useAverageAutoHeightEstimation ? this.averageAutoHeight : estimatedItemSize || null,
        itemSize: itemSize,
        overscanCount: overscanCount,
        itemCount: _react.default.Children.count(children),
        scrollToIndex: scrollToIndex,
        scrollOffset: scrollOffset,
        scrollToAlignment: scrollToAlignment,
        renderItem: function renderItem(_ref) {
          var index = _ref.index,
              style = _ref.style;

          // If some children are strings by accident, support this gracefully.
          if (!_react.default.isValidElement(children[index])) {
            if (typeof children[index] === 'string') {
              return _react.default.createElement("div", {
                style: style
              }, children[index]);
            }

            return _react.default.createElement("div", {
              style: style
            }, "\xA0");
          } // When allowing height="auto" for rows, and a auto height item is
          // rendered for the first time...


          if (allowAutoHeight && _react.default.isValidElement(children[index]) && children[index].props.height === 'auto' && // ... and only when the height is not already been calculated.
          !_this2.autoHeights[index]) {
            // ... render the item in a helper div, the ref is used to calculate
            // the height of its children.
            return _react.default.createElement("div", {
              ref: function ref(_ref2) {
                return _this2.onVirtualHelperRef(index, _ref2);
              },
              "data-virtual-index": index,
              style: (0, _objectSpread2.default)({
                opacity: 0
              }, style)
            }, children[index]);
          } // When allowAutoHeight is false, or when the height is known.
          // Simply render the item.


          return _react.default.cloneElement(children[index], {
            style: style
          });
        }
      }));
    }
  }]);
  return TableVirtualBody;
}(_react.PureComponent);

exports.default = TableVirtualBody;
TableVirtualBody.displayName = "TableVirtualBody";
(0, _defineProperty2.default)(TableVirtualBody, "propTypes", (0, _objectSpread2.default)({}, _layers.Pane.propTypes, {
  /**
   * Children needs to be an array of a single node.
   */
  children: _propTypes.default.oneOfType([_propTypes.default.arrayOf(_propTypes.default.node), _propTypes.default.node]),

  /**
   * Default height of each row.
   * 48 is the default height of a TableRow.
   */
  defaultHeight: _propTypes.default.number,

  /**
   * When true, support `height="auto"` on children being rendered.
   * This is somewhat of an expirmental feature.
   */
  allowAutoHeight: _propTypes.default.bool,

  /**
   * The overscanCount property passed to react-tiny-virtual-list.
   */
  overscanCount: _propTypes.default.number.isRequired,

  /**
   * When passed, this is used as the `estimatedItemSize` in react-tiny-virtual-list.
   * Only when `allowAutoHeight` and`useAverageAutoHeightEstimation` are false.
   */
  estimatedItemSize: _propTypes.default.number,

  /**
   * When allowAutoHeight is true and this prop is true, the estimated height
   * will be computed based on the average height of auto height rows.
   */
  useAverageAutoHeightEstimation: _propTypes.default.bool,

  /**
   * The scrollToIndex property passed to react-tiny-virtual-list
   */
  scrollToIndex: _propTypes.default.number,

  /**
   * The scrollOffset property passed to react-tiny-virtual-list
   */
  scrollOffset: _propTypes.default.number,

  /**
   * The scrollToAlignment property passed to react-tiny-virtual-list
   */
  scrollToAlignment: _propTypes.default.oneOf(['start', 'center', 'end', 'auto'])
}));
(0, _defineProperty2.default)(TableVirtualBody, "defaultProps", {
  defaultHeight: 48,
  allowAutoHeight: false,
  overscanCount: 5,
  useAverageAutoHeightEstimation: true
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90YWJsZS9zcmMvVGFibGVWaXJ0dWFsQm9keS5qcyJdLCJuYW1lcyI6WyJUYWJsZVZpcnR1YWxCb2R5IiwicHJvcHMiLCJzdGF0ZSIsImhlaWdodCIsImNhbGN1bGF0ZWRIZWlnaHQiLCJpc0ludGVnZXJIZWlnaHQiLCJOdW1iZXIiLCJpc0ludGVnZXIiLCJhdXRvSGVpZ2h0cyIsImF1dG9IZWlnaHRSZWZzIiwiYXZlcmFnZUF1dG9IZWlnaHQiLCJkZWZhdWx0SGVpZ2h0IiwiaXNVcGRhdGVkIiwidG90YWwiLCJ0b3RhbEFtb3VudCIsImZvckVhY2giLCJyZWYiLCJpbmRleCIsImNoaWxkTm9kZXMiLCJvZmZzZXRIZWlnaHQiLCJmb3JjZVVwZGF0ZSIsInBhbmVSZWYiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJwcm9jZXNzQXV0b0hlaWdodHMiLCJ1cGRhdGVPblJlc2l6ZSIsImluaXRpYWxpemVIZWxwZXJzIiwic2V0U3RhdGUiLCJjaGlsZHJlbiIsImFsbG93QXV0b0hlaWdodCIsInVzZUF2ZXJhZ2VBdXRvSGVpZ2h0RXN0aW1hdGlvbiIsIm1hcCIsImNoaWxkIiwiUmVhY3QiLCJpc1ZhbGlkRWxlbWVudCIsIml0ZW1TaXplRm4iLCJvblJlc2l6ZSIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiaW5wdXRDaGlsZHJlbiIsInBhbmVIZWlnaHQiLCJvdmVyc2NhbkNvdW50IiwiZXN0aW1hdGVkSXRlbVNpemUiLCJzY3JvbGxUb0luZGV4Iiwic2Nyb2xsT2Zmc2V0Iiwic2Nyb2xsVG9BbGlnbm1lbnQiLCJBcnJheSIsImlzQXJyYXkiLCJDaGlsZHJlbiIsInRvQXJyYXkiLCJpdGVtU2l6ZSIsImdldEl0ZW1TaXplIiwib25SZWYiLCJjb3VudCIsInN0eWxlIiwib25WaXJ0dWFsSGVscGVyUmVmIiwib3BhY2l0eSIsImNsb25lRWxlbWVudCIsIlB1cmVDb21wb25lbnQiLCJQYW5lIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwib25lT2ZUeXBlIiwiYXJyYXlPZiIsIm5vZGUiLCJudW1iZXIiLCJib29sIiwiaXNSZXF1aXJlZCIsIm9uZU9mIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0lBRXFCQSxnQjs7Ozs7OzZDQXNFYUMsSyxFQUFPQyxLLEVBQU87QUFDNUMsVUFBSUQsS0FBSyxDQUFDRSxNQUFOLEtBQWlCRCxLQUFLLENBQUNFLGdCQUEzQixFQUE2QztBQUMzQyxlQUFPO0FBQ0xDLFVBQUFBLGVBQWUsRUFBRUMsTUFBTSxDQUFDQyxTQUFQLENBQWlCTixLQUFLLENBQUNFLE1BQXZCO0FBRFosU0FBUDtBQUdELE9BTDJDLENBTzVDOzs7QUFDQSxhQUFPLElBQVA7QUFDRDs7O0FBRUQsNEJBQVlGLEtBQVosRUFBbUI7QUFBQTs7QUFBQTtBQUNqQixzSEFBTUEsS0FBTjtBQURpQiw4SEFoQlg7QUFDTkksTUFBQUEsZUFBZSxFQUFFLEtBRFg7QUFFTkQsTUFBQUEsZ0JBQWdCLEVBQUU7QUFGWixLQWdCVztBQUFBLDBJQW1CQyxZQUFNO0FBQ3hCLFlBQUtJLFdBQUwsR0FBbUIsRUFBbkI7QUFDQSxZQUFLQyxjQUFMLEdBQXNCLEVBQXRCO0FBQ0EsWUFBS0MsaUJBQUwsR0FBeUIsTUFBS1QsS0FBTCxDQUFXVSxhQUFwQztBQUNELEtBdkJrQjtBQUFBLDJJQTZCRSxZQUFNO0FBQ3pCLFVBQUlDLFNBQVMsR0FBRyxLQUFoQixDQUR5QixDQUd6Qjs7QUFDQSxVQUFJQyxLQUFLLEdBQUcsQ0FBWjtBQUNBLFVBQUlDLFdBQVcsR0FBRyxDQUFsQixDQUx5QixDQU96Qjs7QUFDQSxZQUFLTCxjQUFMLENBQW9CTSxPQUFwQixDQUE0QixVQUFDQyxHQUFELEVBQU1DLEtBQU4sRUFBZ0I7QUFDMUM7QUFDQTtBQUNBLFlBQUksTUFBS1QsV0FBTCxDQUFpQlMsS0FBakIsQ0FBSixFQUE2QjtBQUMzQkosVUFBQUEs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LEVBQUFBLGVBQWUsRUFBRSxLQUZHO0FBR3BCYSxFQUFBQSxhQUFhLEVBQUUsQ0FISztBQUlwQlosRUFBQUEsOEJBQThCLEVBQUU7QUFKWixDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IFB1cmVDb21wb25lbnQgfSBmcm9tICdyZWFjdCdcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcydcbmltcG9ydCBWaXJ0dWFsTGlzdCBmcm9tICdyZWFjdC10aW55LXZpcnR1YWwtbGlzdCdcbmltcG9ydCBkZWJvdW5jZSBmcm9tICdsb2Rhc2guZGVib3VuY2UnXG5pbXBvcnQgeyBQYW5lIH0gZnJvbSAnLi4vLi4vbGF5ZXJzJ1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUYWJsZVZpcnR1YWxCb2R5IGV4dGVuZHMgUHVyZUNvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgLyoqXG4gICAgICogQ29tcG9zZXMgdGhlIFBhbmUgY29tcG9uZW50IGFzIHRoZSBiYXNlLlxuICAgICAqL1xuICAgIC4uLlBhbmUucHJvcFR5cGVzLFxuXG4gICAgLyoqXG4gICAgICogQ2hpbGRyZW4gbmVlZHMgdG8gYmUgYW4gYXJyYXkgb2YgYSBzaW5nbGUgbm9kZS5cbiAgICAgKi9cbiAgICBjaGlsZHJlbjogUHJvcFR5cGVzLm9uZU9mVHlwZShbXG4gICAgICBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMubm9kZSksXG4gICAgICBQcm9wVHlwZXMubm9kZVxuICAgIF0pLFxuXG4gICAgLyoqXG4gICAgICogRGVmYXVsdCBoZWlnaHQgb2YgZWFjaCByb3cuXG4gICAgICogNDggaXMgdGhlIGRlZmF1bHQgaGVpZ2h0IG9mIGEgVGFibGVSb3cuXG4gICAgICovXG4gICAgZGVmYXVsdEhlaWdodDogUHJvcFR5cGVzLm51bWJlcixcblxuICAgIC8qKlxuICAgICAqIFdoZW4gdHJ1ZSwgc3VwcG9ydCBgaGVpZ2h0PVwiYXV0b1wiYCBvbiBjaGlsZHJlbiBiZWluZyByZW5kZXJlZC5cbiAgICAgKiBUaGlzIGlzIHNvbWV3aGF0IG9mIGFuIGV4cGlybWVudGFsIGZlYXR1cmUuXG4gICAgICovXG4gICAgYWxsb3dBdXRvSGVpZ2h0OiBQcm9wVHlwZXMuYm9vbCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBvdmVyc2NhbkNvdW50IHByb3BlcnR5IHBhc3NlZCB0byByZWFjdC10aW55LXZpcnR1YWwtbGlzdC5cbiAgICAgKi9cbiAgICBvdmVyc2NhbkNvdW50OiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBXaGVuIHBhc3NlZCwgdGhpcyBpcyB1c2VkIGFzIHRoZSBgZXN0aW1hdGVkSXRlbVNpemVgIGluIHJlYWN0LXRpbnktdmlydHVhbC1saXN0LlxuICAgICAqIE9ubHkgd2hlbiBgYWxsb3dBdXRvSGVpZ2h0YCBhbmRgdXNlQXZlcmFnZUF1dG9IZWlnaHRFc3RpbWF0aW9uYCBhcmUgZmFsc2UuXG4gICAgICovXG4gICAgZXN0aW1hdGVkSXRlbVNpemU6IFByb3BUeXBlcy5udW1iZXIsXG5cbiAgICAvKipcbiAgICAgKiBXaGVuIGFsbG93QXV0b0hlaWdodCBpcyB0cnVlIGFuZCB0aGlzIHByb3AgaXMgdHJ1ZSwgdGhlIGVzdGltYXRlZCBoZWlnaHRcbiAgICAgKiB3aWxsIGJlIGNvbXB1dGVkIGJhc2VkIG9uIHRoZSBhdmVyYWdlIGhlaWdodCBvZiBhdXRvIGhlaWdodCByb3dzLlxuICAgICAqL1xuICAgIHVzZUF2ZXJhZ2VBdXRvSGVpZ2h0RXN0aW1hdGlvbjogUHJvcFR5cGVzLmJvb2wsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgc2Nyb2xsVG9JbmRleCBwcm9wZXJ0eSBwYXNzZWQgdG8gcmVhY3QtdGlueS12aXJ0dWFsLWxpc3RcbiAgICAgKi9cbiAgICBzY3JvbGxUb0luZGV4OiBQcm9wVHlwZXMubnVtYmVyLFxuICAgIC8qKlxuICAgICAqIFRoZSBzY3JvbGxPZmZzZXQgcHJvcGVydHkgcGFzc2VkIHRvIHJlYWN0LXRpbnktdmlydHVhbC1saXN0XG4gICAgICovXG4gICAgc2Nyb2xsT2Zmc2V0OiBQcm9wVHlwZXMubnVtYmVyLFxuICAgIC8qKlxuICAgICAqIFRoZSBzY3JvbGxUb0FsaWdubWVudCBwcm9wZXJ0eSBwYXNzZWQgdG8gcmVhY3QtdGlueS12aXJ0dWFsLWxpc3RcbiAgICAgKi9cbiAgICBzY3JvbGxUb0FsaWdubWVudDogUHJvcFR5cGVzLm9uZU9mKFsnc3RhcnQnLCAnY2VudGVyJywgJ2VuZCcsICdhdXRvJ10pXG4gIH1cblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIGRlZmF1bHRIZWlnaHQ6IDQ4LFxuICAgIGFsbG93QXV0b0hlaWdodDogZmFsc2UsXG4gICAgb3ZlcnNjYW5Db3VudDogNSxcbiAgICB1c2VBdmVyYWdlQXV0b0hlaWdodEVzdGltYXRpb246IHRydWVcbiAgfVxuXG4gIHN0YXRlID0ge1xuICAgIGlzSW50ZWdlckhlaWdodDogZmFsc2UsXG4gICAgY2FsY3VsYXRlZEhlaWdodDogMFxuICB9XG5cbiAgc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhwcm9wcywgc3RhdGUpIHtcbiAgICBpZiAocHJvcHMuaGVpZ2h0ICE9PSBzdGF0ZS5jYWxjdWxhdGVkSGVpZ2h0KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpc0ludGVnZXJIZWlnaHQ6IE51bWJlci5pc0ludGVnZXIocHJvcHMuaGVpZ2h0KVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFJldHVybiBudWxsIHRvIGluZGljYXRlIG5vIGNoYW5nZSB0byBzdGF0ZS5cbiAgICByZXR1cm4gbnVsbFxuICB9XG5cbiAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcylcblxuICAgIHRoaXMuaW5pdGlhbGl6ZUhlbHBlcnMoKVxuXG4gICAgLy8gQWRkIGEgb25SZXNpemUuXG4gICAgdGhpcy5vblJlc2l6ZSA9IGRlYm91bmNlKHRoaXMub25SZXNpemUsIDIwMClcbiAgfVxuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIC8vIENhbGwgdGhpcyB0byBpbml0aWFsaXplIGFuZCBzZXRcbiAgICB0aGlzLnVwZGF0ZU9uUmVzaXplKClcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5vblJlc2l6ZSwgZmFsc2UpXG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5vblJlc2l6ZSlcbiAgfVxuXG4gIGluaXRpYWxpemVIZWxwZXJzID0gKCkgPT4ge1xuICAgIHRoaXMuYXV0b0hlaWdodHMgPSBbXVxuICAgIHRoaXMuYXV0b0hlaWdodFJlZnMgPSBbXVxuICAgIHRoaXMuYXZlcmFnZUF1dG9IZWlnaHQgPSB0aGlzLnByb3BzLmRlZmF1bHRIZWlnaHRcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGZ1bmN0aW9uIHdpbGwgcHJvY2VzcyBhbGwgaXRlbXMgdGhhdCBoYXZlIGhlaWdodD1cImF1dG9cIiBzZXQuXG4gICAqIEl0IHdpbGwgbG9vcCB0aHJvdWdoIGFsbCByZWZzIGFuZCBnZXQgY2FsY3VsYXRlIHRoZSBoZWlnaHQuXG4gICAqL1xuICBwcm9jZXNzQXV0b0hlaWdodHMgPSAoKSA9PiB7XG4gICAgbGV0IGlzVXBkYXRlZCA9IGZhbHNlXG5cbiAgICAvLyBUaGlzIHdpbGwgZGV0ZXJtaW5lIHRoZSBhdmVyYWdlQXV0b0hlaWdodC5cbiAgICBsZXQgdG90YWwgPSAwXG4gICAgbGV0IHRvdGFsQW1vdW50ID0gMFxuXG4gICAgLy8gTG9vcCB0aHJvdWdoIGFsbCBvZiB0aGUgcmVmcyB0aGF0IGhhdmUgaGVpZ2h0PVwiYXV0b1wiLlxuICAgIHRoaXMuYXV0b0hlaWdodFJlZnMuZm9yRWFjaCgocmVmLCBpbmRleCkgPT4ge1xuICAgICAgLy8gSWYgdGhlIGhlaWdodCBpcyBhbHJlYWR5IGNhbGN1bGF0ZWQsIHNraXAgaXQsXG4gICAgICAvLyBidXQgY2FsY3VsYXRlIHRoZSBoZWlnaHQgZm9yIHRoZSB0b3RhbC5cbiAgICAgIGlmICh0aGlzLmF1dG9IZWlnaHRzW2luZGV4XSkge1xuICAgICAgICB0b3RhbCArPSB0aGlzLmF1dG9IZWlnaHRzW2luZGV4XVxuICAgICAgICB0b3RhbEFtb3VudCArPSAxXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICAvLyBNYWtlIHN1cmUgdGhlIHJlZiBoYXMgYSBjaGlsZFxuICAgICAgaWYgKFxuICAgICAgICByZWYgJiZcbiAgICAgICAgcmVmLmNoaWxkTm9kZXMgJiZcbiAgICAgICAgcmVmLmNoaWxkTm9kZXNbMF0gJiZcbiAgICAgICAgTnVtYmVyLmlzSW50ZWdlcihyZWYuY2hpbGROb2Rlc1swXS5vZmZzZXRIZWlnaHQpXG4gICAgICApIHtcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gcmVmLmNoaWxkTm9kZXNbMF0ub2Zmc2V0SGVpZ2h0XG5cbiAgICAgICAgLy8gQWRkIHRvIHRoZSB0b3RhbCB0byBjYWxjdWxhdGUgdGhlIGF2ZXJhZ2VBdXRvSGVpZ2h0LlxuICAgICAgICB0b3RhbCArPSBoZWlnaHRcbiAgICAgICAgdG90YWxBbW91bnQgKz0gMVxuXG4gICAgICAgIC8vIENhY2hlIHRoZSBoZWlnaHQuXG4gICAgICAgIHRoaXMuYXV0b0hlaWdodHNbaW5kZXhdID0gaGVpZ2h0XG5cbiAgICAgICAgLy8gU2V0IHRoZSB1cGRhdGUgZmxhZyB0byB0cnVlLlxuICAgICAgICBpc1VwZGF0ZWQgPSB0cnVlXG4gICAgICB9XG4gICAgfSlcblxuICAgIC8vIFNhdmUgdGhlIGF2ZXJhZ2UgaGVpZ2h0LlxuICAgIHRoaXMuYXZlcmFnZUF1dG9IZWlnaHQgPSB0b3RhbCAvIHRvdGFsQW1vdW50XG5cbiAgICAvLyBUaGVyZSBhcmUgc29tZSBuZXcgaGVpZ2h0cyBkZXRlY3RlZCB0aGF0IGhhZCBwcmV2aW91c2x5IG5vdCBiZWVuIGNhbGN1bGF0ZWQuXG4gICAgLy8gQ2FsbCBmb3JjZVVwZGF0ZSB0byBtYWtlIHN1cmUgdGhlIHZpcnR1YWwgbGlzdCByZW5kZXJzIGFnYWluLlxuICAgIGlmIChpc1VwZGF0ZWQpIHRoaXMuZm9yY2VVcGRhdGUoKVxuICB9XG5cbiAgb25SZWYgPSByZWYgPT4ge1xuICAgIHRoaXMucGFuZVJlZiA9IHJlZlxuICB9XG5cbiAgb25WaXJ0dWFsSGVscGVyUmVmID0gKGluZGV4LCByZWYpID0+IHtcbiAgICB0aGlzLmF1dG9IZWlnaHRSZWZzW2luZGV4XSA9IHJlZlxuXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIHRoaXMucHJvY2Vzc0F1dG9IZWlnaHRzKClcbiAgICB9KVxuICB9XG5cbiAgb25SZXNpemUgPSAoKSA9PiB7XG4gICAgdGhpcy51cGRhdGVPblJlc2l6ZSgpXG4gIH1cblxuICB1cGRhdGVPblJlc2l6ZSA9ICgpID0+IHtcbiAgICB0aGlzLmluaXRpYWxpemVIZWxwZXJzKClcblxuICAgIC8vIFNpbXBseSByZXR1cm4gd2hlbiB3ZSBub3cgdGhlIGhlaWdodCBvZiB0aGUgcGFuZSBpcyBmaXhlZC5cbiAgICBpZiAodGhpcy5zdGF0ZS5pc0ludGVnZXJIZWlnaHQpIHJldHVyblxuXG4gICAgLy8gUmV0dXJuIGlmIHdlIGFyZSBpbiBhIHdlaXJkIGVkZ2UgY2FzZSBpbiB3aGljaCB0aGUgcmVmIGlzIG5vIGxvbmdlciB2YWxpZC5cbiAgICBpZiAodGhpcy5wYW5lUmVmKSB7XG4gICAgICBjb25zdCBjYWxjdWxhdGVkSGVpZ2h0ID0gdGhpcy5wYW5lUmVmLm9mZnNldEhlaWdodFxuXG4gICAgICBpZiAoY2FsY3VsYXRlZEhlaWdodCA+IDApIHtcbiAgICAgICAgLy8gU2F2ZSB0aGUgY2FsY3VsYXRlZCBoZWlnaHQgd2hpY2ggaXMgbmVlZGVkIGZvciB0aGUgVmlydHVhbExpc3QuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgIGNhbGN1bGF0ZWRIZWlnaHRcbiAgICAgICAgfSlcblxuICAgICAgICAvLyBQcmV2ZW50IHVwZGF0ZU9uUmVzaXplIGJlaW5nIGNhbGxlZCByZWN1cnNpdmVseSB3aGVuIHRoZXJlIGlzIGEgdmFsaWQgaGVpZ2h0LlxuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBXaGVuIGhlaWdodCBpcyBzdGlsbCAwIChvciBwYW5lUmVmIGlzIG5vdCB2YWxpZCkgdHJ5IHJlY3Vyc2l2ZWx5IHVudGlsIHN1Y2Nlc3MuXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIHRoaXMudXBkYXRlT25SZXNpemUoKVxuICAgIH0pXG4gIH1cblxuICBnZXRJdGVtU2l6ZSA9IGNoaWxkcmVuID0+IHtcbiAgICBjb25zdCB7XG4gICAgICBhbGxvd0F1dG9IZWlnaHQsXG4gICAgICB1c2VBdmVyYWdlQXV0b0hlaWdodEVzdGltYXRpb24sXG4gICAgICBkZWZhdWx0SGVpZ2h0XG4gICAgfSA9IHRoaXMucHJvcHNcblxuICAgIC8vIFByZWZlciB0byByZXR1cm4gYSBhcnJheSBvZiBhbGwgaGVpZ2h0cy5cbiAgICBpZiAoIWFsbG93QXV0b0hlaWdodCkge1xuICAgICAgcmV0dXJuIGNoaWxkcmVuLm1hcChjaGlsZCA9PiB7XG4gICAgICAgIGlmICghUmVhY3QuaXNWYWxpZEVsZW1lbnQoY2hpbGQpKSByZXR1cm4gZGVmYXVsdEhlaWdodFxuICAgICAgICBjb25zdCB7IGhlaWdodCB9ID0gY2hpbGQucHJvcHNcblxuICAgICAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcihoZWlnaHQpKSB7XG4gICAgICAgICAgcmV0dXJuIGhlaWdodFxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGRlZmF1bHRIZWlnaHRcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgLy8gSWYgYWxsb3dBdXRvSGVpZ2h0IGlzIHRydWUsIHJldHVybiBhIGZ1bmN0aW9uIGluc3RlYWQuXG4gICAgY29uc3QgaXRlbVNpemVGbiA9IGluZGV4ID0+IHtcbiAgICAgIGlmICghUmVhY3QuaXNWYWxpZEVsZW1lbnQoY2hpbGRyZW5baW5kZXhdKSkgcmV0dXJuIGRlZmF1bHRIZWlnaHRcbiAgICAgIGNvbnN0IHsgaGVpZ2h0IH0gPSBjaGlsZHJlbltpbmRleF0ucHJvcHNcblxuICAgICAgLy8gV2hlbiB0aGUgaGVpZ2h0IGlzIG51bWJlciBzaW1wbHksIHNpbXBseSByZXR1cm4gaXQuXG4gICAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcihoZWlnaHQpKSB7XG4gICAgICAgIHJldHVybiBoZWlnaHRcbiAgICAgIH1cblxuICAgICAgLy8gV2hlbiBhbGxvd0F1dG9IZWlnaHQgaXMgc2V0IGFuZCAgdGhlIGhlaWdodCBpcyBzZXQgdG8gXCJhdXRvXCIuLi5cbiAgICAgIGlmIChhbGxvd0F1dG9IZWlnaHQgJiYgY2hpbGRyZW5baW5kZXhdLnByb3BzLmhlaWdodCA9PT0gJ2F1dG8nKSB7XG4gICAgICAgIC8vIC4uLiBhbmQgdGhlIGhlaWdodCBpcyBjYWxjdWxhdGVkLCByZXR1cm4gdGhlIGNhbGN1bGF0ZWQgaGVpZ2h0LlxuICAgICAgICBpZiAodGhpcy5hdXRvSGVpZ2h0c1tpbmRleF0pIHJldHVybiB0aGlzLmF1dG9IZWlnaHRzW2luZGV4XVxuXG4gICAgICAgIC8vIC4uLiBpZiB0aGUgaGVpZ2h0IGlzIG5vdCB5ZXQgY2FsY3VsYXRlZCwgcmV0dXJuIHRoZSBhdmVyZ2VcbiAgICAgICAgaWYgKHVzZUF2ZXJhZ2VBdXRvSGVpZ2h0RXN0aW1hdGlvbikgcmV0dXJuIHRoaXMuYXZlcmFnZUF1dG9IZWlnaHRcbiAgICAgIH1cblxuICAgICAgLy8gUmV0dXJuIHRoZSBkZWZhdWx0IGhlaWdodC5cbiAgICAgIHJldHVybiBkZWZhdWx0SGVpZ2h0XG4gICAgfVxuXG4gICAgcmV0dXJuIGl0ZW1TaXplRm5cbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7XG4gICAgICBjaGlsZHJlbjogaW5wdXRDaGlsZHJlbixcbiAgICAgIGhlaWdodDogcGFuZUhlaWdodCxcbiAgICAgIGRlZmF1bHRIZWlnaHQsXG4gICAgICBhbGxvd0F1dG9IZWlnaHQsXG4gICAgICBvdmVyc2NhbkNvdW50LFxuICAgICAgZXN0aW1hdGVkSXRlbVNpemUsXG4gICAgICB1c2VBdmVyYWdlQXV0b0hlaWdodEVzdGltYXRpb24sXG4gICAgICBzY3JvbGxUb0luZGV4LFxuICAgICAgc2Nyb2xsT2Zmc2V0LFxuICAgICAgc2Nyb2xsVG9BbGlnbm1lbnQsXG4gICAgICAuLi5wcm9wc1xuICAgIH0gPSB0aGlzLnByb3BzXG5cbiAgICAvLyBDaGlsZHJlbiBhbHdheXMgbmVlZHMgdG8gYmUgYW4gYXJyYXkuXG4gICAgY29uc3QgY2hpbGRyZW4gPSBBcnJheS5pc0FycmF5KGlucHV0Q2hpbGRyZW4pXG4gICAgICA/IGlucHV0Q2hpbGRyZW5cbiAgICAgIDogUmVhY3QuQ2hpbGRyZW4udG9BcnJheShpbnB1dENoaWxkcmVuKVxuXG4gICAgY29uc3QgaXRlbVNpemUgPSB0aGlzLmdldEl0ZW1TaXplKGNoaWxkcmVuKVxuXG4gICAgLy8gVmlydHVhbExpc3QgbmVlZHMgYSBmaXhlZCBoZWlnaHQuXG4gICAgY29uc3QgeyBjYWxjdWxhdGVkSGVpZ2h0LCBpc0ludGVnZXJIZWlnaHQgfSA9IHRoaXMuc3RhdGVcblxuICAgIHJldHVybiAoXG4gICAgICA8UGFuZVxuICAgICAgICBkYXRhLWV2ZXJncmVlbi10YWJsZS1ib2R5XG4gICAgICAgIGlubmVyUmVmPXt0aGlzLm9uUmVmfVxuICAgICAgICBoZWlnaHQ9e3BhbmVIZWlnaHR9XG4gICAgICAgIGZsZXg9XCIxXCJcbiAgICAgICAgb3ZlcmZsb3c9XCJoaWRkZW5cIlxuICAgICAgICB7Li4ucHJvcHN9XG4gICAgICA+XG4gICAgICAgIDxWaXJ0dWFsTGlzdFxuICAgICAgICAgIGhlaWdodD17aXNJbnRlZ2VySGVpZ2h0ID8gcGFuZUhlaWdodCA6IGNhbGN1bGF0ZWRIZWlnaHR9XG4gICAgICAgICAgd2lkdGg9XCIxMDAlXCJcbiAgICAgICAgICBlc3RpbWF0ZWRJdGVtU2l6ZT17XG4gICAgICAgICAgICBhbGxvd0F1dG9IZWlnaHQgJiYgdXNlQXZlcmFnZUF1dG9IZWlnaHRFc3RpbWF0aW9uXG4gICAgICAgICAgICAgID8gdGhpcy5hdmVyYWdlQXV0b0hlaWdodFxuICAgICAgICAgICAgICA6IGVzdGltYXRlZEl0ZW1TaXplIHx8IG51bGxcbiAgICAgICAgICB9XG4gICAgICAgICAgaXRlbVNpemU9e2l0ZW1TaXplfVxuICAgICAgICAgIG92ZXJzY2FuQ291bnQ9e292ZXJzY2FuQ291bnR9XG4gICAgICAgICAgaXRlbUNvdW50PXtSZWFjdC5DaGlsZHJlbi5jb3VudChjaGlsZHJlbil9XG4gICAgICAgICAgc2Nyb2xsVG9JbmRleD17c2Nyb2xsVG9JbmRleH1cbiAgICAgICAgICBzY3JvbGxPZmZzZXQ9e3Njcm9sbE9mZnNldH1cbiAgICAgICAgICBzY3JvbGxUb0FsaWdubWVudD17c2Nyb2xsVG9BbGlnbm1lbnR9XG4gICAgICAgICAgcmVuZGVySXRlbT17KHsgaW5kZXgsIHN0eWxlIH0pID0+IHtcbiAgICAgICAgICAgIC8vIElmIHNvbWUgY2hpbGRyZW4gYXJlIHN0cmluZ3MgYnkgYWNjaWRlbnQsIHN1cHBvcnQgdGhpcyBncmFjZWZ1bGx5LlxuICAgICAgICAgICAgaWYgKCFSZWFjdC5pc1ZhbGlkRWxlbWVudChjaGlsZHJlbltpbmRleF0pKSB7XG4gICAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGRyZW5baW5kZXhdID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHJldHVybiA8ZGl2IHN0eWxlPXtzdHlsZX0+e2NoaWxkcmVuW2luZGV4XX08L2Rpdj5cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICByZXR1cm4gPGRpdiBzdHlsZT17c3R5bGV9PiZuYnNwOzwvZGl2PlxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBXaGVuIGFsbG93aW5nIGhlaWdodD1cImF1dG9cIiBmb3Igcm93cywgYW5kIGEgYXV0byBoZWlnaHQgaXRlbSBpc1xuICAgICAgICAgICAgLy8gcmVuZGVyZWQgZm9yIHRoZSBmaXJzdCB0aW1lLi4uXG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgIGFsbG93QXV0b0hlaWdodCAmJlxuICAgICAgICAgICAgICBSZWFjdC5pc1ZhbGlkRWxlbWVudChjaGlsZHJlbltpbmRleF0pICYmXG4gICAgICAgICAgICAgIGNoaWxkcmVuW2luZGV4XS5wcm9wcy5oZWlnaHQgPT09ICdhdXRvJyAmJlxuICAgICAgICAgICAgICAvLyAuLi4gYW5kIG9ubHkgd2hlbiB0aGUgaGVpZ2h0IGlzIG5vdCBhbHJlYWR5IGJlZW4gY2FsY3VsYXRlZC5cbiAgICAgICAgICAgICAgIXRoaXMuYXV0b0hlaWdodHNbaW5kZXhdXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgLy8gLi4uIHJlbmRlciB0aGUgaXRlbSBpbiBhIGhlbHBlciBkaXYsIHRoZSByZWYgaXMgdXNlZCB0byBjYWxjdWxhdGVcbiAgICAgICAgICAgICAgLy8gdGhlIGhlaWdodCBvZiBpdHMgY2hpbGRyZW4uXG4gICAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPGRpdlxuICAgICAgICAgICAgICAgICAgcmVmPXtyZWYgPT4gdGhpcy5vblZpcnR1YWxIZWxwZXJSZWYoaW5kZXgsIHJlZil9XG4gICAgICAgICAgICAgICAgICBkYXRhLXZpcnR1YWwtaW5kZXg9e2luZGV4fVxuICAgICAgICAgICAgICAgICAgc3R5bGU9e3tcbiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogMCxcbiAgICAgICAgICAgICAgICAgICAgLi4uc3R5bGVcbiAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAge2NoaWxkcmVuW2luZGV4XX1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBXaGVuIGFsbG93QXV0b0hlaWdodCBpcyBmYWxzZSwgb3Igd2hlbiB0aGUgaGVpZ2h0IGlzIGtub3duLlxuICAgICAgICAgICAgLy8gU2ltcGx5IHJlbmRlciB0aGUgaXRlbS5cbiAgICAgICAgICAgIHJldHVybiBSZWFjdC5jbG9uZUVsZW1lbnQoY2hpbGRyZW5baW5kZXhdLCB7XG4gICAgICAgICAgICAgIHN0eWxlXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH19XG4gICAgICAgIC8+XG4gICAgICA8L1BhbmU+XG4gICAgKVxuICB9XG59XG4iXX0=